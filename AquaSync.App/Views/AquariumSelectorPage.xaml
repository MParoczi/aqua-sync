<Page
  x:Class="AquaSync.App.Views.AquariumSelectorPage"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:models="using:AquaSync.App.Models"
  xmlns:converters="using:AquaSync.App.Converters">

  <Page.Resources>
    <converters:NullToDefaultImageConverter x:Key="NullToDefaultImageConverter" />
    <converters:AquariumStatusToOpacityConverter x:Key="StatusToOpacityConverter" />
    <converters:BoolToVisibilityConverter x:Key="BoolToVisibility" />
    <converters:StringNotEmptyToVisibilityConverter x:Key="StringNotEmptyToVisibility" />
  </Page.Resources>

  <Grid Padding="32">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>

    <!-- Page title -->
    <TextBlock
      Grid.Row="0"
      Text="My Aquariums"
      Style="{StaticResource TitleLargeTextBlockStyle}"
      Margin="0,0,0,24" />

    <!-- Notifications (FR-039) -->
    <StackPanel Grid.Row="1" Spacing="4">
      <InfoBar
        Title="{x:Bind ViewModel.NotificationMessage, Mode=OneWay}"
        IsOpen="{x:Bind ViewModel.IsNotificationOpen, Mode=OneWay}"
        Severity="Success"
        IsClosable="True" />
      <InfoBar
        Title="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
        IsOpen="{x:Bind ViewModel.IsErrorOpen, Mode=OneWay}"
        Severity="Error"
        IsClosable="True" />
    </StackPanel>

    <!-- Loading indicator -->
    <ProgressRing
      Grid.Row="2"
      IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
      Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
      HorizontalAlignment="Center"
      VerticalAlignment="Center" />

    <!-- Empty state (FR-003) -->
    <StackPanel
      x:Name="EmptyStatePanel"
      Grid.Row="2"
      HorizontalAlignment="Center"
      VerticalAlignment="Center"
      Spacing="16"
      Visibility="Collapsed">

      <Image
        Source="ms-appx:///Assets/aquarium-default.png"
        Width="120"
        Height="120"
        HorizontalAlignment="Center"
        Opacity="0.6" />

      <TextBlock
        Text="No aquariums yet"
        Style="{StaticResource SubtitleTextBlockStyle}"
        HorizontalAlignment="Center"
        Foreground="{ThemeResource TextFillColorSecondaryBrush}" />

      <Button
        Content="Create your first aquarium"
        Style="{StaticResource AccentButtonStyle}"
        HorizontalAlignment="Center"
        Click="AddAquariumCard_Click" />
    </StackPanel>

    <!-- Aquarium grid (FR-001, FR-006) -->
    <GridView
      x:Name="AquariumGrid"
      Grid.Row="2"
      ItemsSource="{x:Bind ViewModel.Profiles, Mode=OneWay}"
      IsItemClickEnabled="True"
      ItemClick="AquariumGrid_ItemClick"
      SelectionMode="None"
      Visibility="Collapsed">

      <!-- "Add Aquarium" card in header — persistent entry point (FR-004) -->
      <GridView.Header>
        <Button
          Width="244"
          Height="284"
          Margin="0,0,16,16"
          Padding="0"
          CornerRadius="8"
          BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
          BorderThickness="1"
          Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
          HorizontalContentAlignment="Center"
          VerticalContentAlignment="Center"
          Click="AddAquariumCard_Click">
          <StackPanel
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            Spacing="12">
            <FontIcon
              Glyph="&#xE710;"
              FontFamily="{ThemeResource SymbolThemeFontFamily}"
              FontSize="36"
              Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
            <TextBlock
              Text="Add Aquarium"
              Style="{StaticResource BodyStrongTextBlockStyle}"
              Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
          </StackPanel>
        </Button>
      </GridView.Header>

      <GridView.ItemsPanel>
        <ItemsPanelTemplate>
          <ItemsWrapGrid
            Orientation="Horizontal"
            ItemWidth="260"
            ItemHeight="300" />
        </ItemsPanelTemplate>
      </GridView.ItemsPanel>

      <!-- Profile card template (FR-002) -->
      <GridView.ItemTemplate>
        <DataTemplate x:DataType="models:Aquarium">
          <Grid
            Width="244"
            Height="284"
            CornerRadius="8"
            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="1"
            Opacity="{x:Bind Status, Mode=OneWay, Converter={StaticResource StatusToOpacityConverter}}">

            <!-- Context menu (FR-007) -->
            <Grid.ContextFlyout>
              <MenuFlyout Opening="CardMenuFlyout_Opening">
                <MenuFlyoutItem
                  Text="Archive"
                  Tag="{x:Bind}"
                  Click="ArchiveMenuItem_Click">
                  <MenuFlyoutItem.Icon>
                    <FontIcon Glyph="&#xE7B8;" />
                  </MenuFlyoutItem.Icon>
                </MenuFlyoutItem>
                <MenuFlyoutItem
                  Text="Restore"
                  Tag="{x:Bind}"
                  Click="RestoreMenuItem_Click">
                  <MenuFlyoutItem.Icon>
                    <FontIcon Glyph="&#xE777;" />
                  </MenuFlyoutItem.Icon>
                </MenuFlyoutItem>
                <MenuFlyoutItem
                  Text="Delete"
                  Tag="{x:Bind}"
                  Click="DeleteMenuItem_Click">
                  <MenuFlyoutItem.Icon>
                    <FontIcon Glyph="&#xE74D;" />
                  </MenuFlyoutItem.Icon>
                </MenuFlyoutItem>
              </MenuFlyout>
            </Grid.ContextFlyout>

            <Grid.RowDefinitions>
              <RowDefinition Height="140" />
              <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Thumbnail image -->
            <Image
              Grid.Row="0"
              Source="{x:Bind ThumbnailPath, Mode=OneWay, Converter={StaticResource NullToDefaultImageConverter}}"
              Stretch="UniformToFill" />

            <!-- Card details -->
            <StackPanel
              Grid.Row="1"
              Padding="12,8"
              Spacing="2">
              <TextBlock
                Text="{x:Bind Name, Mode=OneWay}"
                Style="{StaticResource BodyStrongTextBlockStyle}"
                MaxLines="1"
                TextTrimming="CharacterEllipsis" />
              <TextBlock
                Text="{x:Bind AquariumType, Mode=OneWay}"
                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                Style="{StaticResource CaptionTextBlockStyle}" />
              <TextBlock
                Text="{x:Bind VolumeDisplay, Mode=OneWay}"
                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                Style="{StaticResource CaptionTextBlockStyle}" />
              <TextBlock
                Text="{x:Bind SetupDateDisplay, Mode=OneWay}"
                Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                Style="{StaticResource CaptionTextBlockStyle}" />
            </StackPanel>

            <!-- Archived badge overlay (FR-029) -->
            <Border
              Grid.Row="0"
              Background="{ThemeResource SystemFillColorCautionBackgroundBrush}"
              CornerRadius="4"
              Padding="8,4"
              HorizontalAlignment="Right"
              VerticalAlignment="Top"
              Margin="0,8,8,0"
              Visibility="{x:Bind IsArchived, Mode=OneWay, Converter={StaticResource BoolToVisibility}}">
              <TextBlock
                Text="Archived"
                Style="{StaticResource CaptionTextBlockStyle}"
                FontWeight="SemiBold" />
            </Border>
          </Grid>
        </DataTemplate>
      </GridView.ItemTemplate>
    </GridView>

    <!-- Profile creation dialog (FR-008, FR-013, FR-014) -->
    <ContentDialog
      x:Name="CreateProfileDialog"
      Title="New Aquarium"
      PrimaryButtonText="Save"
      CloseButtonText="Cancel"
      DefaultButton="Primary"
      FullSizeDesired="False"
      PrimaryButtonClick="CreateProfileDialog_PrimaryButtonClick"
      Closing="CreateProfileDialog_Closing">

      <ContentDialog.Resources>
      </ContentDialog.Resources>

      <ScrollViewer
        VerticalScrollBarVisibility="Auto"
        HorizontalScrollBarVisibility="Disabled"
        HorizontalScrollMode="Disabled"
        MaxHeight="520"
        Padding="0,0,16,0">

        <StackPanel Spacing="16">

          <!-- Name (VR-001) -->
          <StackPanel Spacing="4">
            <TextBox
              Header="Name"
              Text="{x:Bind ViewModel.NewName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
              MaxLength="100"
              PlaceholderText="e.g. Living Room Tank" />
            <TextBlock
              Text="{x:Bind ViewModel.NameError, Mode=OneWay}"
              Foreground="{ThemeResource SystemFillColorCriticalBrush}"
              Style="{StaticResource CaptionTextBlockStyle}"
              Visibility="{x:Bind ViewModel.NameError, Mode=OneWay, Converter={StaticResource StringNotEmptyToVisibility}}" />
            <TextBlock
              Text="{x:Bind ViewModel.DuplicateNameWarning, Mode=OneWay}"
              Foreground="{ThemeResource SystemFillColorCautionBrush}"
              Style="{StaticResource CaptionTextBlockStyle}"
              Visibility="{x:Bind ViewModel.DuplicateNameWarning, Mode=OneWay, Converter={StaticResource StringNotEmptyToVisibility}}" />
          </StackPanel>

          <!-- Volume with unit toggle (FR-008, FR-009, FR-015, VR-002) -->
          <StackPanel Spacing="4">
            <Grid ColumnSpacing="12">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
              </Grid.ColumnDefinitions>
              <NumberBox
                Grid.Column="0"
                Header="Volume"
                Value="{x:Bind ViewModel.NewVolume, Mode=TwoWay}"
                Minimum="0"
                MinWidth="0"
                SpinButtonPlacementMode="Compact"
                PlaceholderText="0" />
              <ToggleSwitch
                Grid.Column="1"
                IsOn="{x:Bind ViewModel.IsVolumeLiters, Mode=TwoWay}"
                OnContent="Liters"
                OffContent="Gallons"
                VerticalAlignment="Bottom"
                Margin="0,0,0,2" />
            </Grid>
            <TextBlock
              Text="{x:Bind ViewModel.VolumeError, Mode=OneWay}"
              Foreground="{ThemeResource SystemFillColorCriticalBrush}"
              Style="{StaticResource CaptionTextBlockStyle}"
              Visibility="{x:Bind ViewModel.VolumeError, Mode=OneWay, Converter={StaticResource StringNotEmptyToVisibility}}" />
          </StackPanel>

          <!-- Dimensions with unit toggle (FR-008, FR-010, FR-015, VR-003/4/5) -->
          <StackPanel Spacing="4">
            <TextBlock
              Text="Dimensions"
              Style="{StaticResource BodyStrongTextBlockStyle}" />
            <Grid ColumnSpacing="8" RowSpacing="8">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
              </Grid.ColumnDefinitions>
              <NumberBox
                Grid.Column="0"
                Header="Length"
                Value="{x:Bind ViewModel.NewLength, Mode=TwoWay}"
                Minimum="0"
                MinWidth="0"
                PlaceholderText="0" />
              <NumberBox
                Grid.Column="1"
                Header="Width"
                Value="{x:Bind ViewModel.NewWidth, Mode=TwoWay}"
                Minimum="0"
                MinWidth="0"
                PlaceholderText="0" />
              <NumberBox
                Grid.Column="2"
                Header="Height"
                Value="{x:Bind ViewModel.NewHeight, Mode=TwoWay}"
                Minimum="0"
                MinWidth="0"
                PlaceholderText="0" />
            </Grid>
            <ToggleSwitch
              IsOn="{x:Bind ViewModel.IsDimensionCentimeters, Mode=TwoWay}"
              OnContent="Centimeters"
              OffContent="Inches" />
            <TextBlock
              Text="{x:Bind ViewModel.DimensionError, Mode=OneWay}"
              Foreground="{ThemeResource SystemFillColorCriticalBrush}"
              Style="{StaticResource CaptionTextBlockStyle}"
              Visibility="{x:Bind ViewModel.DimensionError, Mode=OneWay, Converter={StaticResource StringNotEmptyToVisibility}}" />
          </StackPanel>

          <!-- Aquarium type (VR-006) -->
          <StackPanel Spacing="4">
            <ComboBox
              Header="Aquarium Type"
              ItemsSource="{x:Bind ViewModel.AquariumTypes}"
              SelectedIndex="{x:Bind ViewModel.NewAquariumTypeIndex, Mode=TwoWay}"
              HorizontalAlignment="Stretch"
              PlaceholderText="Select a type" />
            <TextBlock
              Text="{x:Bind ViewModel.TypeError, Mode=OneWay}"
              Foreground="{ThemeResource SystemFillColorCriticalBrush}"
              Style="{StaticResource CaptionTextBlockStyle}"
              Visibility="{x:Bind ViewModel.TypeError, Mode=OneWay, Converter={StaticResource StringNotEmptyToVisibility}}" />
          </StackPanel>

          <!-- Setup date (VR-007) -->
          <StackPanel Spacing="4">
            <CalendarDatePicker
              Header="Setup Date"
              Date="{x:Bind ViewModel.NewSetupDate, Mode=TwoWay}"
              HorizontalAlignment="Stretch"
              PlaceholderText="Select a date" />
            <TextBlock
              Text="{x:Bind ViewModel.DateError, Mode=OneWay}"
              Foreground="{ThemeResource SystemFillColorCriticalBrush}"
              Style="{StaticResource CaptionTextBlockStyle}"
              Visibility="{x:Bind ViewModel.DateError, Mode=OneWay, Converter={StaticResource StringNotEmptyToVisibility}}" />
          </StackPanel>

          <!-- Notes (optional) -->
          <TextBox
            Header="Notes"
            Text="{x:Bind ViewModel.NewNotes, Mode=TwoWay}"
            AcceptsReturn="True"
            TextWrapping="Wrap"
            MaxLength="2000"
            Height="100"
            PlaceholderText="Optional notes about this aquarium" />

          <!-- Substrates (FR-018, FR-019, FR-020) -->
          <StackPanel Spacing="8">
            <TextBlock
              Text="Substrates and Additives"
              Style="{StaticResource BodyStrongTextBlockStyle}" />

            <!-- Substrate list -->
            <ListView
              ItemsSource="{x:Bind ViewModel.NewSubstrates, Mode=OneWay}"
              SelectionMode="None">
              <ListView.ItemTemplate>
                <DataTemplate x:DataType="models:SubstrateEntry">
                  <Grid ColumnSpacing="8" Padding="0,4">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*" />
                      <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Spacing="2">
                      <TextBlock Style="{StaticResource BodyTextBlockStyle}">
                        <Run Text="{x:Bind Brand}" FontWeight="SemiBold" />
                        <Run Text=" — " />
                        <Run Text="{x:Bind ProductName}" />
                      </TextBlock>
                      <TextBlock
                        Style="{StaticResource CaptionTextBlockStyle}"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                        <Run Text="{x:Bind Type}" />
                        <Run Text=" · " />
                        <Run Text="{x:Bind LayerDepth}" />
                      </TextBlock>
                    </StackPanel>
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="2">
                      <Button
                        Padding="4"
                        ToolTipService.ToolTip="Move up"
                        Click="MoveSubstrateUp_Click"
                        Tag="{x:Bind}">
                        <FontIcon Glyph="&#xE74A;" FontSize="12" />
                      </Button>
                      <Button
                        Padding="4"
                        ToolTipService.ToolTip="Move down"
                        Click="MoveSubstrateDown_Click"
                        Tag="{x:Bind}">
                        <FontIcon Glyph="&#xE74B;" FontSize="12" />
                      </Button>
                      <Button
                        Padding="4"
                        ToolTipService.ToolTip="Remove"
                        Click="RemoveSubstrate_Click"
                        Tag="{x:Bind}">
                        <FontIcon Glyph="&#xE74D;" FontSize="12" />
                      </Button>
                    </StackPanel>
                  </Grid>
                </DataTemplate>
              </ListView.ItemTemplate>
            </ListView>

            <!-- Inline substrate entry form (FR-021) -->
            <StackPanel
              Spacing="8"
              Visibility="{x:Bind ViewModel.IsAddingSubstrate, Mode=OneWay, Converter={StaticResource BoolToVisibility}}"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
              BorderThickness="1"
              CornerRadius="4"
              Padding="12">
              <Grid ColumnSpacing="8">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <TextBox
                  Grid.Column="0"
                  Header="Brand"
                  Text="{x:Bind ViewModel.EntryBrand, Mode=TwoWay}"
                  MinWidth="0"
                  PlaceholderText="e.g. ADA" />
                <TextBox
                  Grid.Column="1"
                  Header="Product Name"
                  Text="{x:Bind ViewModel.EntryProductName, Mode=TwoWay}"
                  MinWidth="0"
                  PlaceholderText="e.g. Amazonia" />
              </Grid>
              <Grid ColumnSpacing="8">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <ComboBox
                  Grid.Column="0"
                  Header="Type"
                  ItemsSource="{x:Bind ViewModel.SubstrateTypes}"
                  SelectedIndex="{x:Bind ViewModel.EntryTypeIndex, Mode=TwoWay}"
                  HorizontalAlignment="Stretch"
                  MinWidth="0"
                  PlaceholderText="Select type" />
                <NumberBox
                  Grid.Column="1"
                  Value="{x:Bind ViewModel.EntryLayerDepth, Mode=TwoWay}"
                  Minimum="0"
                  MinWidth="0"
                  PlaceholderText="0">
                  <NumberBox.Header>
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <TextBlock Text="Layer Depth" />
                      <TextBlock
                        Text="{x:Bind ViewModel.DimensionUnitLabel, Mode=OneWay}"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                    </StackPanel>
                  </NumberBox.Header>
                </NumberBox>
              </Grid>
              <CalendarDatePicker
                Header="Date Added"
                Date="{x:Bind ViewModel.EntryDateAdded, Mode=TwoWay}"
                HorizontalAlignment="Stretch"
                PlaceholderText="Select a date" />
              <TextBox
                Header="Notes (optional)"
                Text="{x:Bind ViewModel.EntryNotes, Mode=TwoWay}"
                PlaceholderText="Optional notes" />
              <TextBlock
                Text="{x:Bind ViewModel.SubstrateEntryError, Mode=OneWay}"
                Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                Style="{StaticResource CaptionTextBlockStyle}"
                Visibility="{x:Bind ViewModel.SubstrateEntryError, Mode=OneWay, Converter={StaticResource StringNotEmptyToVisibility}}" />
              <StackPanel Orientation="Horizontal" Spacing="8">
                <Button
                  Content="Add Entry"
                  Style="{StaticResource AccentButtonStyle}"
                  Click="SaveSubstrateEntry_Click" />
                <Button
                  Content="Cancel"
                  Click="CancelSubstrateEntry_Click" />
              </StackPanel>
            </StackPanel>

            <!-- Add Substrate button (hidden while adding) -->
            <Button
              Content="Add Substrate"
              Click="ShowSubstrateForm_Click"
              Visibility="{x:Bind ViewModel.IsAddingSubstrate, Mode=OneWay, Converter={StaticResource BoolToVisibility}, ConverterParameter=invert}" />
          </StackPanel>

          <!-- Thumbnail photo (FR-012) -->
          <StackPanel Spacing="8">
            <TextBlock
              Text="Thumbnail Photo"
              Style="{StaticResource BodyStrongTextBlockStyle}" />
            <Image
              Source="{x:Bind ViewModel.ThumbnailPreview, Mode=OneWay}"
              MaxHeight="160"
              HorizontalAlignment="Left"
              Stretch="Uniform"
              Visibility="{x:Bind ViewModel.HasThumbnailPreview, Mode=OneWay, Converter={StaticResource BoolToVisibility}}" />
            <StackPanel Orientation="Horizontal" Spacing="8">
              <Button
                Content="Browse..."
                Click="BrowsePhoto_Click" />
              <Button
                Content="Clear"
                Click="ClearPhoto_Click"
                Visibility="{x:Bind ViewModel.HasThumbnailPreview, Mode=OneWay, Converter={StaticResource BoolToVisibility}}" />
            </StackPanel>
            <TextBlock
              x:Name="PhotoErrorText"
              Foreground="{ThemeResource SystemFillColorCriticalBrush}"
              Style="{StaticResource CaptionTextBlockStyle}"
              Visibility="Collapsed" />
          </StackPanel>

          <!-- Discard confirmation (FR-014) -->
          <InfoBar
            Title="Discard changes?"
            Message="You have unsaved data. Are you sure you want to discard?"
            IsOpen="{x:Bind ViewModel.ShowDiscardConfirmation, Mode=OneWay}"
            Severity="Warning"
            IsClosable="False">
            <InfoBar.ActionButton>
              <Button
                Content="Discard"
                Click="ConfirmDiscard_Click" />
            </InfoBar.ActionButton>
          </InfoBar>

        </StackPanel>
      </ScrollViewer>
    </ContentDialog>
  </Grid>
</Page>
